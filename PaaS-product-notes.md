# PaaS 产品学习笔记

以下内容的**分析思路**主要摘抄整理自[Cloud Foundry:从数字化战略到实现](https://www.amazon.cn/dp/B075VW5Y7H)，作者是Pivotal资深专家，通过此书将Pivotal主要维护的开源 PaaS 项目 Cloud Foundry 的设计目标和其以此为基础的商业产品Pivotal Cloud Foundry的商业逻辑介绍给读者（当然不乏广告的嫌疑）

PaaS 产品解决的主要问题是降低SaaS应用的开发门槛，提高开发效率，它的直接用户是软件开发相关人员（包括且不限于开发工程师、运维工程师等，一些监控和日志等数据收集展示功能也适合产品及分析人员使用）

通常来说，PaaS层产品都会有如下的设计目标（处于产品目标、定位、市场各方面的考虑，并非全部都一定是用户所特别关心的）：

+ 要能运行在任一的IaaS层产品上，无论是以公有云为主的Azure、AWS、aliyun，还是OpenStack还是vSphere
  - 这样开发人员只要熟悉一个P层平台，就可以开发出适合任何I层的S层产品
  - 同时在具体特性的技术栈上不依赖于某一个特定的I层厂商
+ 支持各类的主流服务端开发语言和运行环境
  - 微服务化的设计趋势让研发团队并不值得绑死在一种开发语言和解决方案上，根据实际的业务特点和需求选择会更有效率
  - P层进入docker时代之后，更多的是将已有的devOps实践向linux容器编排上在做迁移，各家产品也在趋于同质化，但由于各家理解能力不同，还是有高下之分，主要体现在support解决方案的能力上
  - 微软.NET开源并发布linux版本意味着基本上windows平台不在这个领域直接参与竞争了
+ 多大程度上支撑[12 factor](https://12factor.net/zh_cn/)开发参考准则
  - 这是一个被广泛接受的来自 heroku（ 它本身就是做PaaS的 ，这个准则也被Spring Cloud官方文档所提及）的设计准则，一个成熟的SaaS平台应该尽可能帮助开发团队满足这12项要求
  - 这一点最为重要，因为它实际上更贴和产品本身的需求

考虑到在**越来越多的商业行为被数据所驱动**这个趋势上（这会导致应用研发的需求来自于数据分析的结果），一个PaaS平台是否:

+ 具备一个成熟的大数据套件解决方案

也会是一些成熟且有远见的PaaS层产品必须考虑的一个设计目标


选用PaaS平台的目的是为了能帮助自身以更高效率、更低成本、更低门槛的开发和交付具备弹性的SaaS服务功能

1. 更高效率，开箱即用，可以省掉起步的各种问题
2. 更低门槛，不是所有的开发人员都精通分布式弹性设计
3. 更低的时间成本，即便是有经验的的高水平的研发团队，也需要相当的精力来贯彻相关设计经验和原则，远不如直接的基础设施支撑来的实惠
4. 更低的人力成本，直接省去了维护一揽子基础设施的专职人员成本


以上4项产品特点（产品固有性能）和4项选用目的（特定产品使用者的主观诉求，需求），是拉力形成最终性价比判断的主要考虑因素，也因此，最后的表格打分难免有主观因素掺杂在内，这里需要对这些判断条件先做一些具体的阐述和分析：

# 产品特点部分：

## I层无关性：

### 差异有那么严重么

+ 目前的I层实现都可以简单的理解为虚拟化（最近bare metal风潮回归，主要是个别技术强大的玩儿家试图进一步突破原有市场格局做出的努力，成熟度要保持怀疑），实质类同，更多的在于价格和结算方式带来的采购方财务结算行为的差异
+ 真正的差异确实有，后面的分析会表明，真正的差异恰恰在于I层厂商对P层的渗透

### 真正很难做到I层无关

但是P层在向I层部署时，及I层节点接入P层已有平台这两方面还是有很大差异的，依赖于P层的实现方式

这里开始引入阿里云进行陪跑，它并不能认为是一个独立的PaaS产品，但是它的一些产品功能明显能为了达成PaaS产品的目标（更快更好地开发S层产品）而做出的努力，所以在此进行对比，阿里云不存在统一的P层平台产品（或者就认为它的阿里云控制台就是一个统一的P层产品即可），它实际上是由容器集群和codepipeline两部分

+ P层部署
  - 灵雀提供的是云托管版本，无需部署，但是他们通过k8s兼容性认证的可是distribution的版本，这里面界限在哪儿？更有意思的是时速通过k8s兼容性认证的是hosted的产品，然后...
  - 时速云托管版本不支持本地环境，只能私有化部署，且没有自动化安装工具（他们安装时候有ansible，干嘛的？）
  - 这里提一下Pivotal，或者说Cloud Foundry，它的方式比较独特，主要是他们自己维护了一个开源的bosh工具，然后根据预先配置好的一个安装清单进行一键化部署（自己宣传的）
  - 阿里云前面提到的，它实际上是多个分离产品构成的，k8s集群可以认为是购买ECS的另一个通道，codepipeline和云效则是需要分别开通，有一定的免费额度，超过需要提工单购买（这种行为方式说明，还没有充分研发完成，至少计费等模块还未完全）

+ 新增I层节点
  - 灵雀和时速的方式都类似（时速和灵雀），需要管理员在节点上执行一段脚本（包括没来陪跑的daocloud也是这样）
  - 阿里云是购买页面，自动provision来完成的

## 支持各类的主流服务端开发语言和运行环境

+ 这个现在也已经趋于同质化了，因为都是构建在k8s的基础上的，实际上都是跑容器
+ 我们采购的产品在这方面主要是体现在CI/CD构建方面的差异
  - 灵雀有针对java部署环境的对接的功能，但是还在测试阶段，我们试用阶段对方的支持不太理想，也和我们对这类平台还不熟悉有关，用很多固有的观念来套现在的概念
  - 时速根据我们的需求，给出了一个比较容易理解的解决方案，且能跑通，有些细节还需确认
  - 阿里云codepipeline明确列明了几种环境，反正目前只关注java；云效就是阿里内部淘系上线管理工具，主要就是针对java提供支持
  - 其他的没有深度试用到这个阶段

## 平台能够支持12 factor原则的程度

严格地说，这份清单有些年头了，有几项在容器的时代看起来就好像是废话

12 factor准则是用来指导SaaS层设计的，我们的关注点在S层设计和实现，所以考察P层对S层设计原则的支撑是一个重点，它既能梳理出自身的潜在需求，也能帮助来分析观察P层产品在特定方面的成熟度


### 一份基准代码，多份部署
- 时速和灵雀产品本身都集成有CI/CD或部署流水线功能，但是不特别处理各个环境衔接的问题
- 阿里云通过一个单独的产品云效显式的提供了一份部署流水线模板，引导用户按这个原则来进行部署
- 通过沟通，时速和灵雀仅售卖产品和产品功能使用服务，此类咨询服务均单独收费，其推荐强依赖容器解决方案定制解决特定环节的细节问题

在这一点上，都具备必要的能力
>
> 但是在多个环境的衔接上，商业产品除了阿里云，目前没有看到有特别优势的地方，都需要自己花精力处理这个问题

### 显式声明依赖关系
- 这一点主要依赖项目中使用的构建工具，而试用的各个平台产品对此的支持在于能否更好的提供对该构建工具的支持
- 灵雀平台没有单独设计第三方依赖库缓存功能，试用期间也没有提出合理的解决方案
- 时速平台没有单独设计第三方依赖库缓存功能，但给出了基于容器方案的相对合理的方案
- 阿里云codepipeline有第三方依赖库缓存功能，但有个免责条款：带缓存的构建节点会缓存您的私服依赖包，请谨慎使用！

> 在这一点上，都可以做的到，但是在多个环境的衔接上，商业产品除了阿里云，目前没有看到有特别优势的地方，都需要自己花精力处理这个问题

### 在环境中存储配置（外化配置）
- 这一点如果自维/自研通常需要设计一个集中的配置中心来达成
- 灵雀和时速目前预计可能采购的平台没有显式的功能提供支持，时速有单独的微服务产品平台集成支持，灵雀有一个标注为beta的功能菜单，可以帮助我们部署Spring Cloud套件中的基础设施
- 阿里云有ACM产品对此提供支持，它实际上就是阿里开源项目diamond的线上托管版本
- 这个东西一开始考虑选型Apollo是有点道听途说，Spring Cloud Config 目前实际采用的可能性比较大
- 其他产品没有了解到这个程度

### 把后端服务当作附加资源
- 这一点就是要求，对基础设施（比如MySQL）也要有有弹性的适配方案
- I层对此渗透较好，所以一般都会优先选择I层的服务
- 时速有独立的数据库和缓存板块，但是成熟度（是需要相当的技术功底的）相比较I层厂商值得推敲
- 灵雀产品也有对常用中间件的托管式服务（其实也就是镜像加配置），和时速本质是差不多的，同样是成熟度的评估，定制方面不知道是否还会有额外报价

### 严格分离构建、发布和运行
- 这通常是一项devOps最佳实践，需要很多人的行为和工具规则设置
- 灵雀、时速、阿里云产品中都没有显著的处理这一步骤的功能选项，但是考虑到这一点个性化程度比较高，可以理解
- 和灵雀、时速的技术人员交流时，没有明确的感受到对方对这一点的理解和在这方面的实践支持经验，但考虑到他们基于容器平台，应该有能力可以形成多种解决方案

### 以一个或多个无状态进程运行应用
- 总的来说，这个偏向一个设计问题
- 灵雀和时速都是基于k8s的概念对此提供进一步的支撑
- 阿里云还是偏I层，不直接在这个维度予以特别支撑

### 通过端口绑定(Port binding)来提供服务
- 这是一种设计风格，他更需要的是一种组织级观念的转变而非工具支撑，这一点掠过

### 快速启动和优雅终止可最大化健壮性
- 这依赖于应用和依赖基础设施的设计风格，灵雀和时速基于k8s容器平台能力，具备这方面的基本条件
- 阿里云提供独立的不附加任何额外功能的纯k8s托管服务（目前处于免费期）

### 通过进程模型进行扩展
- 灵雀、时速、阿里均通过k8s对此种设计风格基于支撑

### 尽可能的保持开发，预发布，线上环境相同
- 基于容器的解决方案更容易的贴近这个目标
- 很大程度上混合云是这个原则的反模式
- 灵雀、时速在这方面有优势，他们在管理不同的环境是在一个统一的界面之下，虽然I层面对的资源形式是不同的，但是我们通常认为这一层差异较小
- 对于k8s容器方案，这一层的特点在于存储，以解决跨主机迁移时的持久化数据问题（但是如果是无状态服务这一点可能并非痛点）
  - 灵雀选用的是Glusterfs
  - 时速选用的是Ceph
  - 阿里云的k8s没有考察这块，但事实上据目前了解，上面两家选型都是k8s的能力，只是他们自己找了一个自己熟悉的而已

### 把日志当作事件流
- 这一点对传统B/S开发人员的认知就有挑战，它任何的本地日志文件记录都被认为是无效的（或者至少在收集之前，或者都已经不推荐单独再对日志文件做收集）
- 灵雀和时速这一点基于容器的解决方案偷懒了，都有基于容器的集中日志搜索查看功能，但分析查询能力偏弱
- 阿里云有更强大的日志转存和分析服务，由预定义的面向各类常见基础设施的配置，也有基于docker容器输出的捕获，即便使用了灵雀或时速，如果选用阿里云平台，也值的购买SLS服务

### 后台管理任务当作一次性进程运行
+ 容器平台有巨大的优势，因为k8s对此有直接支持
+ 灵雀界面保留了这个功能
+ 时速很奇怪的隐去了这个功能

# 平台产品能提供的大数据套件

+ 前面提到过日志的收集，时速在这方面给出的能力相对一般，同时时速这个品牌目前也没有提供任何大数据相关的解决方案，考虑到这类产品的license都是按使用时长付费的，其实应当考虑形成一种长期的合作伙伴关系，那么在这个方面，时速确实是一个巨大的短板和减分项
+ 虽然阿里云能统计到的往往并非是业务级数据的支撑，但是对完善S层非功能性需求的帮助却是明显的，在没有完善的业务数据收集支持之前，也往往是宝贵的数据分析材料，同时阿里飞天（原来叫ODPS，现在叫MaxCompute），是国内云平台中相对知名的大数据收集和分析平台，在这方面优势就很强了，如果I层使用阿里，在数据未来的集成方面显然更加方便

# 再从主观诉求方面

## 期望更高效，比如快速起步

+ 时速和灵雀都可以当作一个很好的起点，不需要我们自己部署环境，虽然有一些能力的不足，但是基本可以做到开箱即用
+ 我们自己尝试部署k8s，确实历时一周还没有完成，这个也和开始计划时没有全力去执行有关，k8s安装肯定还会遇到墙的问题，有理说不清
+ 阿里云也可以，但是我们起步时遇到的时开发测试环境问题

## 期望更低门槛，让开发人员可以更容易地设计出分布式应用

+ 这方面的能力主要来自于k8s对集群的管理能力，能从一定程度上降低难度，但是有限，主要还是靠研发的设计，这方面只要能起步了，选哪个产品都差不多
+ 阿里云稍差，因为日常环境不是在云上的

## 期望更低的时间成本

+ 在一个直接的基础设施上，去贯彻相关设计经验和原则，也是更容易坚持下去的，所以无论是商业还是自维护，都比完全不用要强
+ 节约下时间一方面去贯彻更重要的原则和传播更有价值的经验，另一方面还可以做很多弹力设计之外的事情，毕竟促成成功的不是单一因素，但是有可能单一的短板就会导致最终的失败，这就是节约的机会成本
+ 但从另一方面来说，商业产品和服务的功能如果并没有达到完全超出预期的水平，那同样会造成时间的浪费，假设这个过程执行自维摸着石头过河，至少团队是积累了实际的更深层次的经验的

## 期望更低的人力成本

+ 只要是自维，必须要考虑诸如灾备、扩容、失败恢复等计划问题，如果采用商业产品，需要做的就是遇到这些问题，打电话，提工单，但是服务品质如何，前期很难估算清楚
+ 当需要的不是环境来证明人是更聪明的，而是需要人来证明环境有这个能力的时候，很可能花出去的钱是打水漂的，所以长期的打造一支深谙devOps法则并持续贯彻的团队才有可能是最终节约整体人力成本的正途

综上所述，我可能是阿里得托儿，尽管并不看好商业产品的远期前景，但是考虑到近期自维的时间进度压力，我支持在开发测试环境先采购一家价格相对较低的商业产品来快速起步，同时并行的进行自维护的学习和团队建设，争取将来采取更灵活的方式采购相关支持共嫩给和产品


注：

+ 因此12 Factor的提出者heroku，在后期也开始大力推进这方面的能力，同时著名Google App Engine，也在不断的扩展他对语言和运行环境支持的能力（当然它可能把未来聚焦在FaaS）
+ 就像很多的 devOps顶级的布道师提到的，永远不应该奢望用了一个或一打产品之后就认为已经万事大吉了